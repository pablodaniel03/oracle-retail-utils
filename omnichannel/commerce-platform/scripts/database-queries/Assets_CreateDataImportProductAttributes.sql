set echo on
REM Querying table



DECLARE
v_AttributeValues varchar2(4000);

v_ProductId varchar2(40);
v_AssetVersion number(19,0);
v_AttributeName varchar2(254);
v_AttributeValue varchar2(254);



BEGIN
v_AttributeValues := NULL;


--EXECUTE IMMEDIATE 'CREATE GLOBAL TEMPORARY TABLE GN_TEMP_PRD_ATTR(itemId varchar2(254), dynamicAttributes varchar2(4000)) ON COMMIT DELETE ROWS';
DELETE FROM GN_TEMP_PRD_ATTR;


FOR c_Products IN (
    SELECT  PRODUCT_ID, ASSET_VERSION
    FROM    ATGDB_PUB.DCS_PRODUCT
    WHERE   PRODUCT_ID IN ('154241','153833','151090','151885','154231','153869','153804','154162','154021','149919','151906','150082','153727','154090','153729','154123','153763','154509','152335','154425','151116','154285','151087','151315','149261','153983','151076','145267','156246','152193','151230','152172','152323','154198','152630','151229','153756','149184','154402','152648','154200','154906','152668','150989','152609','154051','154151','154034','151107','154415','154346','153751','152619','153787','154403','153783','154124','154117','153791','154185','154116','149914','154307','154314','154477','153868','153798','151941','154418','154108','144537','152475','150389','154053','154176','154118','153782','156276','153735','154286','154275','153779','154406','154177','154476','154506','153867','154024','154175','154764','154393','147606','154381','153870','152258','153738','154046','151110','153793','152662','154052','154350','154523','154120','151863','152414','154767','154279','153805','152005','151904','151801','147588','154293','151893','154628','147616','154450','154165','154499','151138','151077','153726','151085','154336','154193','153719','154736','154359','154361','151753','149299','154472','150148','152234','150235','154318','153871','154179','151232','154225','153872','152657','149216','154181','151875','154056','153839','152510','154360','154203','154700','154397','151093','151882','154012','151859','151894','152470','154121','151862','153981','154009','153838','154202','154428','152198','154612','154102','153713','153866','152613','152608','153795','154865','144708','149921','156208','154432','152497','149020','154465','153818','151860','153825','152488','154164','154277','152656','152485','149489','153788','153797','145456','151759','150250','154235','155028','154452','153716','154223','153864','150126','154446','154178','154792','149564','154394','154234','153813','150162','152639','151907','154549','151105','153819','149383','154163','154356','153785','153812','154451','154260','147605','154561','153831','152712','154266','154258','149798','154264','144821','153806','154351','151977','154324','152016','152512','154265','152469','151078','153822','152224','149575','153780','149805','151876','152584','154687','153836','152473','153820','152607','152190','153814','154018','152283','151757','154174','144717','152472','152692')
        AND IS_HEAD = 1
        AND VERSION_DELETED = 0
    ORDER BY PRODUCT_ID)
LOOP
    v_AttributeValues := NULL;
    v_ProductId := TO_CHAR(c_Products.PRODUCT_ID);
    v_AssetVersion := TO_NUMBER(c_Products.ASSET_VERSION);
    
    FOR c_Attributes IN ( 
        SELECT  GN_PA.ATTRIBUTE_NAME, GN_PA.ATTRIBUTE_VALUE
        FROM    ATGDB_PUB.GN_PRD_ATTR GN_PA
        WHERE   GN_PA.PRODUCT_ID = v_ProductId
            AND GN_PA.ASSET_VERSION = v_AssetVersion
        ORDER BY GN_PA.ATTRIBUTE_NAME)
    LOOP
        v_AttributeName := TO_CHAR(c_Attributes.ATTRIBUTE_NAME);
        v_AttributeValue := TO_CHAR(c_Attributes.ATTRIBUTE_VALUE);
    
        /*
        IF v_AttributeName = 'OFFER' THEN
            v_AttributeValue := 1;
        END IF;
        */
        
        IF v_AttributeValues IS NULL THEN
            v_AttributeValues := v_AttributeName || '=' || v_AttributeValue;
        ELSE
            v_AttributeValues := v_AttributeValues || '~' || v_AttributeName || '=' || v_AttributeValue;
        END IF;

    END LOOP;


    INSERT INTO GN_TEMP_PRD_ATTR(itemId, dynamicAttributes) VALUES (TO_CHAR(c_Products.PRODUCT_ID), TO_CHAR(v_AttributeValues));
    --DBMS_OUTPUT.PUT_LINE(c_Products.PRODUCT_ID || '|' || v_AttributeValues);

    
END LOOP;


--COMMIT;

END;



--SELECT * FROM GN_TEMP_PRD_ATTR
